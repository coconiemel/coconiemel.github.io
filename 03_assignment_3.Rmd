# Free future assignment (3) {-}

## Introduction {-}

After this course I will be specializing in microbiology, this is also where I see myself in a couple of years. Data science for me is a great opportunity to combine different work areas and keep my work various, but my main focus will be microbiology. Before i start working in the field, I hope to earn a masters degree, so in two years i will probably be busy with my masters. I am not sure what masters I would like to do.

Because I am interested in microbiology, my free assignment will also be in that lane. I will be learning to generate a phylogenetic tree about the Filoviridae family. I chose this viral family because I am interested in infectious diseases and two species of these are known to cause quite the infectious diseases.

## Plan {-}

To achieve my goal, I had 4 days total planned to work on it. I had divided the days in a couple groups:
<ul><li>Half a day to come up with a plan, write this and search the right data needed.</li>
<li>One day to follow a tutorial and find everything that I need for my own analysis.</li>
<li>Two days to implement my knowledge from searching the internet and the tutorial to the data I will be using and complete generating the tree.</li>
<li>Half a day to finish the writing and details.</li></ul>

## The Filoviridae family {-}

## The phylogenetic tree {-}

```{r libraries in this code}

library(adegenet)
library(Biostrings)
library(msa)
library(kableExtra)
library(ape)
library(ggtree)

```

The code needs two functions from the {compbio4all} package, but Nathan L Brouwer, the writer of the package, states that if there is any trouble downloading the package the (following) codes for the function can be copied. The package in question can be found at [the github repository](https://github.com/brouwern/compbio4all.git). I did have trouble installing the packages, so the code retrieved from github is below.

```{r function codes}

# Function to clean up fasta files
fasta_cleaner <- function(fasta_object, parse = TRUE){

  fasta_object <- sub("^(>)(.*?)(\\n)(.*)(\\n\\n)","\\4",fasta_object)
  fasta_object <- gsub("\n", "", fasta_object)

  if(parse == TRUE){
    fasta_object <- stringr::str_split(fasta_object,
                                       pattern = "",
                                       simplify = FALSE)
  }

  return(fasta_object[[1]])
}

# Function to store fasta sequences into a R list
entrez_fetch_list <- function(db, id, rettype, ...){

  #setup list for storing output
  n.seq <- length(id)
  list.output <- as.list(rep(NA, n.seq))
  names(list.output) <- id

  # get output
  for(i in 1:length(id)){
    list.output[[i]] <- rentrez::entrez_fetch(db = db,
                                              id = id[i],
                                              rettype = rettype)
  }


  return(list.output)
}

```

The analysis starts by fetching the sequences from NCBI and make them compatible for analysis.
The file "species" is written to enhance the target IDs, this way, all the genomes can be fetched at once.

```{r load and adjust sequences}

# Import list of target species
species <-scan(file = ("files/filo_data/species.txt"), what = "character", sep = "\n", comment.char = "#") 

# Obtain fasta sequences of all species combined in a list
filoviridae <- entrez_fetch_list(db = "nucleotide",
             id = species,
             rettype = "fasta") 

# Remove non sequence infromation
for(i in 1:length(filoviridae)){
  filoviridae[[i]] <- fasta_cleaner(filoviridae[[i]], parse = F)
}

# Create string set
filoviridae_vector <- rep(NA, length(filoviridae))

for(i in 1:length(filoviridae_vector)){
  filoviridae_vector[i] <- filoviridae[[i]]
}

names(filoviridae_vector) <- names(filoviridae)

filoviridae_vector_ss <- Biostrings::AAStringSet(filoviridae_vector)

```

Next is the multiple sequence alignment. This creates an alignment to easily spot the distances between all the options. Because this takes a long time to perform, I saved the alignment in a file that can be obtained.

```{r multiple sequence alignment, eval = FALSE}

# Perform multiple sequence alignment
filoviridae_align <- msa(filoviridae_vector_ss,
                     method = "ClustalW")

# Change class into correct one, in this case RNA because Ebola is a RNA-virus
class(filoviridae_align) <- "RNAMultipleAlignment"

# Save in file so alignment only needs to run once
saveRDS(filoviridae_align, ("files/filo_data/filoviridae_align.RDS"))

```

```{r import aligned data}

# Import aligned file for usage
filoviridae_align <- readRDS("files/filo_data/filoviridae_align.RDS")

```

To use the alignment for the tree, the genetic distance between the sequences will be calculated. For readability, a rounded version is also made. After the calculations the tree is plotted. The tree clearly shows that most ebolaviruses are closely related, which is logical because they are only different species, only Reston and Sudan are somewhat further from the rest but close to each other. Is also shows that Mengla dianlovirus and Marburg marburgvirus are closely related, and Lloviu is also nearby.

```{r view msa}

filoviridae_align_seqinr <- msaConvert(filoviridae_align, 
                                   type = "seqinr::alignment")

filoviridae_dist <- seqinr::dist.alignment(filoviridae_align_seqinr, 
                                       matrix = "identity")
filoviridae_dist_rounded <- round(filoviridae_dist,
                              digits = 2)

```

```{r phylogenetic tree}

# Generate the structure of the tree

filoviridae_tree <- nj(filoviridae_dist)

# Plot tree

ggtree(filoviridae_tree, ladderize = T, branch.length = "branch.length", 
       root.position = .05)+ 
  geom_tiplab(size = 3.5)+
  xlim(0, .8)+
  labs(title = "Filoviridae family tree",  
       subtitle = "Rooted phylogenetic tree, with branch lengths")+
  theme(plot.title = element_text(size = 18, face = "bold", hjust = .5), plot.subtitle = element_text(size = 12, face = "italic", hjust = .5))

```


_Figure 2: Phylogenetic tree of the Filoviridae family._

The tree shows an easy picture of the differences, but is doesn't show the numbers in detail. To solve this, I calcutated them separately.

The return of the code below shows the calculated genetic distances of all options. Seen from here is states that Taiforest ebolavirus & Bundibogyo ebolavirus are closest related with a score of 0.56.

It also states that there are multiple options that score furthest related with a score of 0.76. These are: Bombali ebolavirus & Marburg marburgvirus, Bombali ebolavirus & Mengla dianlovirus, Sudan ebolavirus & Marburg marburgvirus, Sudan ebolavirus & Mengla dianlovirus, Reston ebolavirus & Marburg marburgvirus, Lloviu cuevavirus & Marburg marburgvirus, Lloviu cuevavirus & Mengla dianlovirus.


```{r details}

# Details
filoviridae_dist_rounded
min(filoviridae_dist_rounded) 
max(filoviridae_dist_rounded)

```
